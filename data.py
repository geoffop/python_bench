# This script processes benchmark results generated by pyperf and outputs them in HTML and JSON formats.

import glob
import os
import pandas as pd
from pyperf._bench import BenchmarkSuite

# Initialize an empty list to store benchmark results
benchmark_results = []

# Iterate over all JSON files in the current directory
for json_file in glob.glob(os.path.join(os.getcwd(), "*.json")):
    # Extract the Python version from the file name
    python_version = os.path.splitext(os.path.basename(json_file))[0]

    # Load the benchmark suite from the JSON file
    benchmark_suite = BenchmarkSuite.load(json_file)

    # Get the names of all benchmarks in the suite
    benchmark_names = benchmark_suite.get_benchmark_names()

    # Process each benchmark
    for benchmark_name in benchmark_names:
        try:
            # Get the benchmark by name
            benchmark = benchmark_suite.get_benchmark(benchmark_name)
            if benchmark:
                # Extract values from all runs of the benchmark
                for benchmark_run in benchmark.get_values():
                    # Append the benchmark name, value, and Python version to the results list
                    benchmark_results.append({"test": benchmark_name, "value": benchmark_run, "python_ver": python_version})
        except KeyError:
            # Ignore benchmarks that are not found in the suite
            pass

# Convert the results list into a pandas DataFrame
benchmark_dataframe = pd.DataFrame(benchmark_results)

# Write the DataFrame to an HTML file
benchmark_dataframe.to_html("results.html", index=False)

# Write the DataFrame to a JSON file
benchmark_dataframe.to_json("results.json", orient="records")

print(benchmark_dataframe)
